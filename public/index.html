<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>A Blockly-based visual editor for JSON structures.</title>

    <!-- Modern Blockly imports -->
    <script type="text/javascript" src="https://unpkg.com/blockly@latest/blockly_compressed.js"></script>
    <script type="text/javascript" src="https://unpkg.com/blockly@latest/javascript_compressed.js"></script>
    <script type="text/javascript" src="https://unpkg.com/blockly@latest/blocks_compressed.js"></script>
    <script type="text/javascript" src="https://unpkg.com/blockly@latest/msg/en.js"></script>
    
    <!-- Pako removed - using browser built-in decompression -->

    <!-- Custom field and extensions -->
    <script type="text/javascript" src="button-field.js"></script>

    <!-- Core Blockly extensions and primitive blocks -->
    <script type="text/javascript" src="block-extensions.js"></script>
    <script type="text/javascript" src="block-definitions.js"></script>
    <script type="text/javascript" src="json-workspace-converter.js"></script>

    <!-- Tenant properties management -->
    <script type="text/javascript" src="tenant-properties.js"></script>

    <!-- Dynamic block loading from S3, and generates JSON for all object types-->
    <script type="text/javascript" src="schema-loader.js"></script>

    <!-- Keyboard navigation -->
    <script type="text/javascript" src="keyboard-navigation.js"></script>

    <!-- Google OAuth Configuration -->
    <script type="text/javascript" src="oauth-config.js"></script>
    
    <!-- API Configuration -->
    <script type="text/javascript" src="api-config.js"></script>
    
    <!-- CRITICAL: Block ALL network requests and initialization before anything loads -->
    <script type="text/javascript">
        // IMMEDIATE blocking - hide page before DOM loads
        document.write('<style>body { visibility: hidden !important; }</style>');
        
        // Block all initialization
        window.pageBlocked = true;
        window.authCheckInProgress = true;
        window.SECURITY_BLOCK_ALL_REQUESTS = true;
    
        // Override fetch globally to block ALL network requests except auth-related ones
        window.originalFetch = window.fetch;
        window.fetch = function(...args) {
            if (window.SECURITY_BLOCK_ALL_REQUESTS) {
                const url = args[0];
                // If a stored token exists and is not expired, lift the block immediately
                try {
                    const stored = localStorage.getItem('google_access_token');
                    if (stored) {
                        let tokenPayload = null;
                        try { tokenPayload = JSON.parse(stored); } catch (_) {}
                        const token = (tokenPayload && tokenPayload.token) ? tokenPayload.token : stored;
                        const notExpired = !tokenPayload || !tokenPayload.expiresAt || Date.now() < tokenPayload.expiresAt;
                        if (token && notExpired) {
                            window.SECURITY_BLOCK_ALL_REQUESTS = false;
                            return window.originalFetch(...args);
                        }
                    }
                } catch (_) { /* noop */ }
                // Allow only authentication-related requests and essential app requests
                const isAuthRequest = url.includes('/tenant-properties') || 
                                     url.includes('/schemas') ||
                                     url.includes('/api/auth') ||
                                     url.includes('/api/manage_oauth_scopes') ||
                                     url.includes('/api/oauth_token_exchange') ||
                                     url.includes('accounts.google.com') || 
                                     url.includes('googleapis.com/oauth2') ||
                                     url.includes('www.googleapis.com/oauth2') ||
                                     window.API_CONFIG.isApiRequest(url);
                
                if (!isAuthRequest) {
                    console.log('🚫 SECURITY: Network request blocked - authentication required', url);
                    return Promise.reject(new Error('Network requests blocked - authentication required'));
                } else {
                    console.log('✅ SECURITY: Auth-related request allowed', url);
                }
            }
            return window.originalFetch(...args);
        };
        
        // Override XMLHttpRequest to block legacy requests
        const OriginalXMLHttpRequest = window.XMLHttpRequest;
        window.XMLHttpRequest = function() {
            const xhr = new OriginalXMLHttpRequest();
            const originalOpen = xhr.open;
            xhr.open = function(...args) {
                if (window.SECURITY_BLOCK_ALL_REQUESTS) {
                    console.log('🚫 SECURITY: XMLHttpRequest blocked - authentication required', args[1]);
                    throw new Error('XMLHttpRequest blocked - authentication required');
                }
                return originalOpen.apply(this, args);
            };
            return xhr;
        };
        
        // Override any initialization functions immediately
        window.initializeApp = function() {
            console.log('🚫 App initialization blocked - authentication required');
            return false;
        };
        
        window.loadSchema = function() {
            console.log('🚫 Schema loading blocked - authentication required');
            return false;
        };
        
        // Block common schema loading functions
        window.loadSchemaFromServer = function() {
            console.log('🚫 Schema server loading blocked - authentication required');
            return Promise.reject(new Error('Schema loading blocked - authentication required'));
        };
    </script>
    
    <!-- Google OAuth Authentication -->
    <script type="text/javascript" src="google-oauth-auth.js"></script>

    <!-- Validation module -->
    <script type="text/javascript" src="validations.js"></script>
    
    <!-- Main application logic (bundle.js contains main.js functions) -->
    <script type="text/javascript" src="bundle.js"></script>

    <style>
        :root {
            --bg-color: #1e1e1e;
            --text-color: #ffffff;
            --blockly-bg: #1e1e1e;
            --controls-bg: #2d2d30;
            --border-color: #444;
        }
        
        body {
            background-color: var(--bg-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-color);
            margin: 0;
            padding: 0;
        }
        
        h1 {
            font-weight: normal;
            font-size: 140%;
            padding-left: 500px;
            color: #ffffff;
        }
        
        .theme-selector {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px; /* Increased from 10px to 15px (1.5x) */
            border-radius: 8px;
            border: 1px solid #444;
            transform: scale(1.5); /* Scale theme selector 1.5x */
            transform-origin: top right; /* Scale from top-right */
        }
        
        .theme-selector label {
            color: #ffffff;
            font-size: 12px;
            margin-right: 8px;
        }
        
        .theme-selector select {
            background: #333;
            color: #ffffff;
            border: 1px solid #555;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
        }
        
        .theme-selector select:focus {
            outline: none;
            border-color: #007acc;
        }

        /* Authentication UI Styles */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .auth-card {
            background-color: var(--controls-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 2rem;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .auth-card h2 {
            color: var(--text-color);
            margin-bottom: 1rem;
        }

        .auth-card p {
            color: var(--text-color);
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .error-message {
            color: #ff6b6b !important;
            font-weight: bold;
        }

        .auth-button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin: 8px;
        }

        .auth-button:hover {
            background-color: #3367d6;
        }

        .auth-button:focus {
            outline: 2px solid #0078d4;
            outline-offset: 2px;
        }
        
        .top-nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 75px; /* Increased from 50px to 75px (1.5x) */
            background: var(--controls-bg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            z-index: 1000;
            transform: scale(1.5); /* Scale entire nav bar 1.5x */
            transform-origin: top left; /* Scale from top-left */
            width: 66.67%; /* Compensate for scaling */
        }
        
        .nav-button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            color: white;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.3s ease;
            border-right: 1px solid var(--border-color);
            gap: 8px;
        }
        
        .nav-icon {
            width: 20px;
            height: 20px;
            object-fit: contain;
            flex-shrink: 0;
        }
        
        .nav-link:hover {
            text-decoration: none;
            color: white;
        }
        
        /* AI Tools - Green gradient */
        #aiToolsLink .nav-link {
            background: linear-gradient(135deg, #00aa00, #008800);
        }
        
        #aiToolsLink .nav-link:hover {
            background: linear-gradient(135deg, #008800, #00aa00);
        }
        
        /* Billing - Orange gradient */
        #billingLink .nav-link {
            background: linear-gradient(135deg, #FF9800, #F57C00);
        }
        
        #billingLink .nav-link:hover {
            background: linear-gradient(135deg, #F57C00, #FF9800);
        }
        
        /* Admin Panel - Purple gradient */
        #adminPanelLink .nav-link {
            background: linear-gradient(135deg, #9C27B0, #673AB7);
        }
        
        #adminPanelLink .nav-link:hover {
            background: linear-gradient(135deg, #673AB7, #9C27B0);
        }
        
        /* Login - Blue gradient */
        #loginButton .nav-link {
            background: linear-gradient(135deg, #4285f4, #3367d6);
        }
        
        #loginButton .nav-link:hover {
            background: linear-gradient(135deg, #3367d6, #4285f4);
        }
        
        .nav-button:last-child .nav-link {
            border-right: none;
        }
        
        .main-container {
            height: calc(100vh - 112.5px); /* Account for scaled header: 75px * 1.5 = 112.5px */
            margin-top: 112.5px; /* Account for scaled header: 75px * 1.5 = 112.5px */
            position: relative;
        }
        
        .blockly-container {
            height: calc(100vh - 112.5px); /* Account for scaled header: 75px * 1.5 = 112.5px */
            background: var(--blockly-bg);
            position: relative;
            transition: width 0.3s ease;
            width: 100%; /* Full width when panel is closed */
        }
        
        .blockly-container.panel-open {
            width: 20%; /* Only 20% width when panel is open */
        }
        
        .controls-panel {
            position: fixed;
            right: -80vw; /* Hidden by default, slides from right - 80% of viewport width */
            top: 112.5px; /* Account for scaled header: 75px * 1.5 = 112.5px */
            width: 80vw; /* 80% of viewport width */
            height: calc(100vh - 112.5px); /* Account for scaled header: 75px * 1.5 = 112.5px */
            background: var(--controls-bg);
            border-left: 1px solid var(--border-color);
            padding: 15px;
            color: var(--text-color);
            overflow-y: auto; /* Vertical scrollability */
            display: flex;
            flex-direction: column;
            gap: 15px;
            transition: right 0.3s ease;
            z-index: 1000;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .controls-panel.open {
            right: 0;
        }
        
        .controls-content {
            transform: scale(1.5); /* Scale UI elements to 1.5x for better mobile usability */
            transform-origin: top left; /* Scale from top-left corner */
            width: 66.67%; /* Compensate for scaling to maintain proper width */
        }
        
        .panel-toggle {
            position: fixed;
            right: 25px;
            top: 210px; /* Increased from 140px to 210px (1.5x) */
            z-index: 1001;
            background: var(--controls-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px 0 0 8px;
            padding: 12px 18px; /* Increased from 8px 12px to 12px 18px (1.5x) */
            cursor: pointer;
            color: var(--text-color);
            font-size: 21px; /* Increased from 14px to 21px (1.5x) */
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: -2px 0 5px rgba(0, 0, 0, 0.2);
            transform: scale(1.5); /* Scale panel toggle 1.5x */
            transform-origin: top right; /* Scale from top-right */
        }
        
        .panel-toggle:hover {
            background: var(--blockly-bg);
            transform: scale(1.5) translateX(-2px); /* Maintain scaling with hover effect */
        }
        
        .panel-toggle.panel-open {
            right: 80vw; /* Moves with the panel - 80% of viewport width */
            border-radius: 0 8px 8px 0;
        }
        
        .control-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-row label {
            color: #cccccc;
            font-size: 12px;
            font-weight: 600;
            margin: 0;
        }
        
        .http-methods {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            align-items: center;
        }
        
        .http-methods button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            flex: 0 0 auto;
        }
        
        .http-methods button:hover {
            background: #1177bb;
        }
        
        .http-methods button:disabled {
            background: #555;
            cursor: not-allowed;
        }
        
        .http-methods input {
            background: #3c3c3c;
            color: #ffffff;
            border: 1px solid #555;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            flex: 0 0 auto;
            min-width: 100px;
        }
        
        .control-row textarea {
            background: #1e1e1e;
            color: #ffffff;
            border: 1px solid #555;
            padding: 8px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 11px;
            resize: vertical;
            width: 100%;
            min-height: 60px;
        }
        
        .control-row textarea:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .action-buttons button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            flex: 1;
        }
        
        .action-buttons button:hover {
            background: #1177bb;
        }
        
        .primary-button {
            background: #0e639c !important;
        }
        
        .primary-button:hover {
            background: #1177bb !important;
        }
        
        .secondary-button {
            background: #6c757d !important;
        }
        
        .secondary-button:hover {
            background: #5a6268 !important;
        }
        
        .ai-tools-link {
            display: inline-block;
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            margin-top: 10px;
            font-size: 12px;
        }
        
        .ai-tools-link:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            text-decoration: none;
            color: white;
        }
        
        /* Collapsible sections */
        .collapsible-section {
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--controls-bg);
        }
        
        .collapsible-header {
            padding: 10px 15px;
            background: #3c3c3c;
            cursor: pointer;
            user-select: none;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 4px 4px 0 0;
        }
        
        .collapsible-header:hover {
            background: #4c4c4c;
        }
        
        .collapsible-header h4 {
            margin: 0;
            font-size: 12px;
            font-weight: 600;
            color: #cccccc;
        }
        
        .collapsible-toggle {
            font-size: 14px;
            color: #888;
            transition: transform 0.2s ease;
        }
        
        .collapsible-toggle.expanded {
            transform: rotate(90deg);
        }
        
        .collapsible-content {
            padding: 15px;
            display: none;
        }
        
        .collapsible-content.expanded {
            display: block;
        }
        
        .kv-pair {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .kv-pair input {
            background: #3c3c3c;
            color: #ffffff;
            border: 1px solid #555;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 11px;
            flex: 1;
        }
        
        .kv-pair input:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .kv-pair button {
            background: #e22;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            flex: 0 0 auto;
        }
        
        .kv-pair button:hover {
            background: #c11;
        }
        
        .add-kv-button {
            background: #0e639c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            margin-top: 8px;
        }
        
        .add-kv-button:hover {
            background: #1177bb;
        }
        
        /* Count indicators */
        .count-indicator {
            font-size: 11px;
            font-weight: normal;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 10px;
            background: #555;
            color: #fff;
            transition: all 0.2s ease;
        }
        
        .count-indicator.complete {
            background: #0e639c;
            color: #fff;
        }
        
        .count-indicator.incomplete {
            background: #e22;
            color: #fff;
        }
        
        /* Footer buttons scaling */
        #footerButtons {
            transform: scale(1.5); /* Scale footer buttons 1.5x */
            transform-origin: center; /* Scale from center */
        }
        
        #footerButtons button,
        #footerButtons a {
            font-size: 18px !important; /* Increased from 12px to 18px (1.5x) */
            padding: 12px 24px !important; /* Increased from 8px 16px to 12px 24px (1.5x) */
        }
        
        /* Blockly workspace dark theme overrides */
        .blocklyMainBackground {
            fill: #1e1e1e !important;
        }
        
        .blocklyToolboxDiv {
            background-color: #2d2d30 !important;
            border-right: 1px solid #444 !important;
        }
        
        .blocklyFlyout {
            background-color: #2d2d30 !important;
        }
        
        .blocklyScrollbarHandle {
            fill: #555 !important;
        }
        
        .blocklyScrollbarBackground {
            fill: #333 !important;
        }
        
        /* Classic theme - white canvas */
        .classic-theme .blocklySvgGroup {
            background-color: #ffffff !important;
        }
        
        .classic-theme .blocklyMainBackground {
            fill: #ffffff !important;
        }
        
        .classic-theme .blocklyWorkspaceBackground {
            fill: #ffffff !important;
        }
        
        /* Modal visibility classes */
        .modal-hidden {
            display: none !important;
        }
        
        .modal-visible {
            display: block !important;
        }
    </style>
</head>
<body>

<!--<h1>Built complex rules authomatically by <a href=http://jsonlogic.com/>JsonLogic editor</a> utilizing <a href="https://developers.google.com/blockly/">Blockly</a></h1>-->

  <!-- Top Navigation Bar -->
  <div class="top-nav-bar">
    <div class="nav-button" id="aiToolsLink">
      <a href="#" class="nav-link">
        🤖 AI Tools
        <img src="media/swagger.png" alt="API Tools" class="nav-icon" />
      </a>
    </div>
    <div class="nav-button" id="billingLink" style="display: none;">
      <a href="#" class="nav-link">💳 Billing</a>
    </div>
    <div class="nav-button" id="adminPanelLink" style="display: none;">
      <a href="#" class="nav-link">🛠 Admin Panel</a>
    </div>
    <div class="nav-button" id="loginButton" style="display: none;">
      <a href="#" class="nav-link">
        <img src="media/g.webp" alt="Google Login" class="nav-icon" />
        Login
      </a>
    </div>
  </div>

  <div class="main-container">
    <div class="panel-toggle" id="panelToggle" onclick="toggleControlsPanel()">
      <span id="panelToggleText">◀ API Controls</span>
    </div>
    
    <div class="blockly-container" id="blocklyContainer">
      <div class="theme-selector">
        <label for="themeSelect">Theme:</label>
        <select id="themeSelect" onchange="changeTheme()">
          <option value="dark">Dark (Default)</option>
          <option value="classic">Classic</option>
          <option value="modern">Modern</option>
          <option value="colorblind-wong">Colorblind (Wong)</option>
          <option value="colorblind-tol">Colorblind (Tol)</option>
        </select>
      </div>
      <div id="blocklyDiv" style="width: 100%; height: 100%"></div>

    <xml id="toolbox" style="display: none">

        <category name="Dynamic Types" categorystyle="dynamic_category">
            <block type="dictionary"></block>
            <block type="dynarray"></block>
        </category>
       
        <category name="Primitives" categorystyle="primitive_category">
            <block type="start"></block>
            <block type="string"></block>
            <block type="string_array"></block>
            <block type="string_password"></block>
            <block type="string_email"></block>
            <block type="string_enum"></block>
            <block type="number"></block>
            <block type="number_array"></block>
            <block type="boolean"></block>
            <block type="boolean_array"></block>
            <block type="variable"></block>
        </category>

        <!-- Custom Objects category will be populated dynamically based on tenant schemas -->
        <category name="Custom Objects" categorystyle="custom_category" id="custom-objects">
            <!-- Blocks will be added here dynamically -->
        </category>

        <!-- Custom Arrays category will be populated dynamically based on tenant schemas -->
        <category name="Custom Lists" categorystyle="custom_category" id="custom-arrays">
            <!-- Array blocks will be added here dynamically -->
        </category>
        <!---->

        <!-- Custom Arrays category will be populated dynamically based on tenant schemas -->
        <category name="Custom Dictionaries" categorystyle="custom_category" id="custom-dicts">
            <!-- Array blocks will be added here dynamically -->
        </category>
        <!---->
        

    </xml>
    </div>

    <div class="controls-panel">
        <div class="controls-content">
        <!-- Row 1: HTTP Methods -->
        <div class="control-row">
            <label>HTTP Methods</label>
            <div class="http-methods">
                <button id="post" onclick='sendRequests("POST")'>POST</button>
                <input id="path_id" placeholder="existing element id here" oninput="handlePathIdChange()" style="width: 200px;" />
                <button id="put" disabled onclick='sendRequests("PUT")'>PUT</button>
                <button id="patch" disabled onclick='sendRequests("PATCH")'>PATCH</button>
                <button id="get" onclick='sendRequests("GET")'>GET</button>
                <button id="delete" disabled onclick='sendRequests("DELETE")'>DELETE</button>
                <label style="display: flex; align-items: center; gap: 4px; font-size: 12px; color: #ccc;">
                    <input type="checkbox" id="auto_reload" style="margin: 0;" checked>
                    Auto-reload
                </label>
            </div>
        </div>
        
        <!-- Row 2: Route -->
        <div class="control-row">
            <label>      API Route</label>
            <div style="display: flex; gap: 8px; align-items: flex-start;">
                <input id="full_route" placeholder="API endpoint URL" style="height: 40px; flex: 1; padding: 8px; border: 1px solid #555; border-radius: 4px; background: #3c3c3c; color: #ffffff;"></input>
                <div style="display: flex; gap: 4px; align-items: center;">
                    <select id="endpoint_selector" style="background: #3c3c3c; color: #ffffff; border: 1px solid #555; border-radius: 4px; padding: 6px 8px; font-size: 11px; min-width: 120px; height: 40px;" onchange="handleEndpointChange()">
                        <option value="">Select Endpoint</option>
                    </select>
                    <button id="endpoint_info_btn" style="display: none; background: #0e639c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 16px; width: 40px; height: 40px;" onclick="showEndpointInfo()" title="Endpoint Info">?</button>
                </div>
            </div>
        </div>
        
        <!-- Row 3: Current JSON -->
        <div class="control-row">
            <label>Current JSON</label>
            <textarea id="json_area" placeholder="JSON payload" style="height: 180px;"></textarea>
        </div>
        
        <!-- Row 4: Response -->
        <div class="control-row">
            <label>Validations+Responses</label>
            <textarea id="response_area" placeholder="API response" style="height: 120px;"></textarea>
        </div>
        
        <!-- Row 5: Actions -->
        <div class="control-row">
            <label>Actions</label>
            <div class="action-buttons">
                <button id="reverse" onclick='loadFromJson()' class="primary-button">🔗🧩 Rebuild link+blocks from JSON</button>
                <button id="load_disk" onclick='relaxStaticTyping()' class="secondary-button">Relax Static Typing</button>
            </div>
            <div style="margin-top: 8px; margin-left: 8px;">
                <label id="rootSchemaLabel" style="font-size: 10px; color: #aaa;">Root Schema Type (optional):</label>
                <div style="display: flex; align-items: center; gap: 8px; margin-top: 4px;">
                    <input id="root_schema_type" placeholder="dictionary" style="width: 200px; padding: 4px; background: #3c3c3c; color: #ffffff; border: 1px solid #555; border-radius: 4px; font-size: 11px;" />
                    <button id="aiAssistButton" onclick="openAIAssistPanel()" style="padding: 4px 8px; background: #4CAF50; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 4px;" title="AI Assist - Transform JSON with custom instructions">
                        🤖 AI Assist
                    </button>
                </div>
                <div id="rootSchemaDescription" style="font-size: 9px; color: #888; margin-top: 2px;">This will set the type of the root object when rebuilding from JSON</div>
            </div>
        </div>
        
        <!-- Query Parameters Section -->
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible('query-params')">
                <h4>Query Parameters <span id="query-params-count" class="count-indicator">0</span></h4>
                <span class="collapsible-toggle" id="query-params-toggle">▶</span>
            </div>
            <div class="collapsible-content" id="query-params-content">
                <div id="query-params-list">
                    <!-- Query parameter pairs will be added here -->
                </div>
                <button class="add-kv-button" onclick="addQueryParam()">+ Add Query Parameter</button>
            </div>
        </div>
        
        <!-- Headers Section -->
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible('headers')">
                <h4>Headers <span id="headers-count" class="count-indicator">0</span></h4>
                <span class="collapsible-toggle" id="headers-toggle">▶</span>
            </div>
            <div class="collapsible-content" id="headers-content">
                <div id="headers-list">
                    <!-- Header pairs will be added here -->
                </div>
                <button class="add-kv-button" onclick="addHeader()">+ Add Header</button>
            </div>
        </div>
        
        <!-- Variables Section -->
        <div class="collapsible-section">
            <div class="collapsible-header" onclick="toggleCollapsible('variables')">
                <h4>Variables <span id="variables-count" class="count-indicator">0</span></h4>
                <span class="collapsible-toggle" id="variables-toggle">▶</span>
            </div>
            <div class="collapsible-content" id="variables-content">
                <div id="variables-list">
                    <!-- Variable pairs will be added here -->
                </div>
                <button class="add-kv-button" onclick="addVariable()">+ Add Variable</button>
            </div>
        </div>
        </div>
    </div>
  </div>

  <!-- Endpoint Info Modal -->
  <div id="endpointInfoModal" class="modal-hidden" style="display: none !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow: auto;">
    <div style="position: relative; background: var(--controls-bg); margin: 50px auto; max-width: 600px; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color);">
      <button onclick="closeEndpointInfo()" style="position: absolute; top: 10px; right: 10px; background: #e22; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">×</button>
      <h3 style="color: var(--text-color); margin-top: 0;">Endpoint Information</h3>
      <div id="endpointInfoContent" style="color: var(--text-color); font-size: 14px; line-height: 1.6;"></div>
    </div>
  </div>

  <!-- AI Assist Modal -->
  <div id="aiAssistModal" class="modal-hidden" style="display: none !important; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow: auto;">
    <div style="position: relative; background: var(--controls-bg); margin: 20px auto; max-width: 800px; padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); max-height: 90vh; overflow-y: auto;">
      <button onclick="closeAIAssistPanel()" style="position: absolute; top: 10px; right: 10px; background: #e22; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">×</button>
      <h3 style="color: var(--text-color); margin-top: 0; display: flex; align-items: center; gap: 8px;">
        🤖 AI Assist - Transform JSON
      </h3>
      
      <div style="margin-bottom: 20px;">
        <label style="display: block; color: var(--text-color); font-weight: bold; margin-bottom: 8px;">Custom Instructions:</label>
        <textarea id="aiAssistInstructions" placeholder="Enter your transformation instructions here... (e.g., 'Convert all string fields to uppercase', 'Add a timestamp field', 'Remove all null values')" style="width: 100%; height: 120px; padding: 12px; background: #3c3c3c; color: #ffffff; border: 1px solid #555; border-radius: 4px; font-size: 14px; resize: vertical; box-sizing: border-box;"></textarea>
      </div>
      
      <div style="margin-bottom: 20px;">
        <button id="aiAssistSubmit" onclick="submitAIAssistRequest()" style="background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 4px; font-size: 14px; cursor: pointer; font-weight: bold;">
          🚀 Transform JSON
        </button>
        <button onclick="closeAIAssistPanel()" style="background: #666; color: white; border: none; padding: 12px 24px; border-radius: 4px; font-size: 14px; cursor: pointer; margin-left: 10px;">
          Cancel
        </button>
      </div>
      
      <div id="aiAssistResponse" style="margin-top: 20px; padding: 15px; background: #2d2d30; border-radius: 4px; border: 1px solid #555; min-height: 100px; display: none;">
        <h4 style="color: var(--text-color); margin-top: 0;">AI Response:</h4>
        <div id="aiAssistResponseContent" style="color: var(--text-color); font-size: 14px; line-height: 1.6; white-space: pre-wrap;"></div>
      </div>
      
      <div id="aiAssistLoading" style="display: none; text-align: center; padding: 20px; color: var(--text-color);">
        <div style="font-size: 16px; margin-bottom: 10px;">🤖 AI is processing your request...</div>
        <div style="font-size: 12px; color: #888;">This may take a few moments</div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div id="footerButtons" style="position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000; display: flex; gap: 8px; align-items: center;">
    <button id="validationErrorButton" style="
      display: none;
      background: linear-gradient(135deg, #f44336, #d32f2f);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease;
      cursor: pointer;
    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
      ❌ Validation Error
    </button>
    <a href="#" id="presentationLink" style="
      display: none;
      background: linear-gradient(135deg, #4285f4, #3367d6);
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease;
    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
      📸 View a user-facing presentation layer for this API!
    </a>
    <a href="register.html" style="
      display: inline-block;
      background: linear-gradient(135deg, #4CAF50, #45a049);
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      transition: transform 0.2s ease;
    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
      ✨ Like this page? Make your own with Blockforger 💪
    </a>
  </div>

  <!-- Copyright Notice -->
  <div style="position: fixed; bottom: 5px; left: 80%; transform: translateX(-50%); z-index: 999; color: #888; font-size: 10px; text-align: left;">
    © 2025 Blockforger LLC, Wyoming. All rights reserved.
  </div>

  <script>
    // Preserve tenant parameter in AI tools link
    const urlParams = new URLSearchParams(window.location.search);
    let tenant = urlParams.get('tenant');
    
    // Check if we have ?tenant=default but a different last_tenant in localStorage
    const storedTenant = localStorage.getItem('last_tenant');
    if (tenant === 'default' && storedTenant && storedTenant !== 'default') {
      console.log(`Redirecting from ?tenant=default to ?tenant=${storedTenant}`);
      // Refresh the page with the correct tenant parameter
      const newUrl = new URL(window.location);
      newUrl.searchParams.set('tenant', storedTenant);
      window.location.href = newUrl.toString();
      // Stop execution since we're redirecting - no return needed in global scope
    } else {
    
    // If no tenant in URL, default to stored tenant from localStorage
    if (!tenant) {
      tenant = storedTenant || 'default';
      console.log('No tenant in URL, using stored tenant:', tenant);
    }
    
    if (tenant) {
      const aiToolsLink = document.querySelector('#aiToolsLink .nav-link');
      if (aiToolsLink) aiToolsLink.href = `llm-tools.html?tenant=${encodeURIComponent(tenant)}`;
    } else {
      const aiToolsLink = document.querySelector('#aiToolsLink .nav-link');
      if (aiToolsLink) aiToolsLink.href = 'llm-tools.html?tenant=meta';
    }
    // Billing link
    const billingLink = document.querySelector('#billingLink .nav-link');
    if (billingLink) {
      billingLink.href = tenant ? `billing.html?tenant=${encodeURIComponent(tenant)}` : 'billing.html?tenant=meta';
    }
    // Admin panel link
    const adminLink = document.querySelector('#adminPanelLink .nav-link');
    if (adminLink) {
      adminLink.href = tenant ? `admin.html?tenant=${encodeURIComponent(tenant)}` : 'admin.html?tenant=meta';
    }
    } // Close the else block
    
    // Theme management
    let currentWorkspace = null;
    
    // Make currentWorkspace globally available
    window.currentWorkspace = null;
    
    // Clear one-time reload guard; reveal admin link if admin stored in session
    try {
      window.addEventListener('load', () => {
        localStorage.removeItem('auth_reloaded_once');
        
        // Check authentication status and show appropriate buttons
        checkAuthStatus();
        
        // Also check auth status after a short delay to catch any async auth completion
        setTimeout(() => {
          checkAuthStatus();
        }, 500);
        
        // Deserialize headers, query params, and variables from URL
        if (typeof deserializeFromUrl === 'function') {
          deserializeFromUrl();
        }
        
        // Initialize count indicators
        setTimeout(() => {
          if (typeof updateQueryParamsCount === 'function') updateQueryParamsCount();
          if (typeof updateHeadersCount === 'function') updateHeadersCount();
          if (typeof updateVariablesCount === 'function') updateVariablesCount();
          // Initialize full_route field with base route
          if (typeof initializeFullRoute === 'function') initializeFullRoute();
          // Check for presentation layer link
          checkPresentationLink();
          // Show proxy status indicator if proxy is enabled
          if (typeof showProxyStatus === 'function') showProxyStatus();
        }, 100);
      });
    } catch (e) {}
    
    // Function to check for presentation layer link
    window.checkPresentationLink = function checkPresentationLink() {
      const presentationLink = document.getElementById('presentationLink');
      if (!presentationLink) return;
      
      // Check if tenant properties have a "presentation" property
      const tenantProps = window.tenantProperties || {};
      if (tenantProps.presentation && tenantProps.presentation.trim() !== '') {
        // Show the link and set its href
        presentationLink.style.display = 'inline-block';
        presentationLink.href = tenantProps.presentation.trim();
        console.log('Presentation layer link enabled:', tenantProps.presentation);
      } else {
        // Hide the link
        presentationLink.style.display = 'none';
        console.log('No presentation property found in tenant properties');
      }
    };
    
    // Function to check authentication status and show appropriate buttons
    window.checkAuthStatus = function checkAuthStatus() {
      const token = localStorage.getItem('google_access_token');
      const loginButton = document.getElementById('loginButton');
      const billingLink = document.getElementById('billingLink');
      const adminPanelLink = document.getElementById('adminPanelLink');
      
      if (!token) {
        // User not logged in - show login button, hide billing/admin
        if (loginButton) loginButton.style.display = 'flex';
        if (billingLink) billingLink.style.display = 'none';
        if (adminPanelLink) adminPanelLink.style.display = 'none';
      } else {
        // User is logged in - hide login button, show billing/admin based on permissions
        if (loginButton) loginButton.style.display = 'none';
        
        let hasAdminPermission = false;
        let hasBillingPermission = false;
        
        try {
          const perms = sessionStorage.getItem('user_permissions');
          if (perms) {
            const parsed = JSON.parse(perms);
            if (parsed) {
              hasAdminPermission = parsed.admin || false;
              hasBillingPermission = parsed.billing || false;
            }
          }
        } catch (_) {}

        // If we have a token but no permissions, we need to call /auth to get them
        if (!hasAdminPermission && !hasBillingPermission) {
          callAuthForPermissions();
          return; // Exit early, will be called again after auth completes
        }
        
        // Show admin panel for users with admin privileges
        if (adminPanelLink) {
          adminPanelLink.style.display = hasAdminPermission ? 'flex' : 'none';
        }
        
        // Show billing link for users with billing privileges
        if (billingLink) {
          billingLink.style.display = hasBillingPermission ? 'flex' : 'none';
        }
      }
    };
    
    // Function to call /auth endpoint to get permissions
    async function callAuthForPermissions() {
      try {
        const token = localStorage.getItem('google_access_token');
        if (!token) {
          console.log('🔍 No token available for auth call');
          return;
        }
        
        // Get tenant from URL or localStorage
        const urlParams = new URLSearchParams(window.location.search);
        let tenant = urlParams.get('tenant');
        if (!tenant) {
          tenant = localStorage.getItem('last_tenant') || 'default';
        }
        
        console.log('🔍 Calling /auth for tenant:', tenant);
        
        // Parse token to get the actual access token
        let actualToken = token;
        try {
          const tokenObj = JSON.parse(token);
          actualToken = tokenObj.token || token;
        } catch (e) {
          // Token is not JSON, use as-is
        }
        
        // Call the auth endpoint
        const response = await fetch(window.API_CONFIG.AUTH_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            type: 'auth',
            body: {
              extension: tenant,
              google_access_token: actualToken,
              scope: 'all'
            }
          })
        });
        
        if (response.ok) {
          let data = await response.json();
          
          // Unwrap API Gateway response if needed
          if (data && typeof data.body === 'string') {
            try {
              data = JSON.parse(data.body);
            } catch (e) {
              console.error('🔍 Failed to parse response body:', e);
            }
          }
          
          // Check if the response indicates an expired session (statusCode 401)
          if (data.statusCode === 401) {
            console.log('🔍 Session expired (statusCode 401), showing login button');
            // Clear stored token and permissions
            localStorage.removeItem('google_access_token');
            sessionStorage.removeItem('user_permissions');
            localStorage.removeItem('user_permissions');
            // Show login button
            checkAuthStatus();
            return;
          }
          
          if (data.permissions) {
            // Store permissions in sessionStorage and localStorage
            sessionStorage.setItem('user_permissions', JSON.stringify(data.permissions));
            localStorage.setItem('user_permissions', JSON.stringify(data.permissions));
            
            // Call checkAuthStatus again to update UI
            checkAuthStatus();
          }
        } else {
          console.error('🔍 Auth call failed:', response.status, await response.text());
        }
      } catch (error) {
        console.error('🔍 Error calling auth:', error);
      }
    };
    
    // Add click handler for login button
    document.addEventListener('DOMContentLoaded', () => {
      const loginButton = document.getElementById('loginButton');
      if (loginButton) {
        const loginLink = loginButton.querySelector('.nav-link');
        if (loginLink) {
          loginLink.addEventListener('click', async (e) => {
            e.preventDefault();
          console.log('Login button clicked!');
          
          // Create GoogleAuth instance if it doesn't exist
          if (!window.googleAuth) {
            window.googleAuth = new GoogleOAuthAuth();
          }
          
          try {
            if (!window.googleAuth.tokenClient) {
              await window.googleAuth.loadGoogleAPI();
              await window.googleAuth.loadClientConfig();
              await window.googleAuth.initGoogleSignIn();
            }
            
            console.log('Triggering OAuth popup...');
            window.googleAuth.tokenClient.requestAccessToken({
              prompt: 'consent'
            });
          } catch (error) {
            console.error('Login failed:', error);
            console.error('Error details:', error.message, error.stack);
          }
        });
        }
      }
      
      // Listen for storage changes to update UI when user logs in/out
      window.addEventListener('storage', (e) => {
        if (e.key === 'google_access_token' || e.key === 'user_permissions') {
          console.log('🔍 Storage change detected for:', e.key);
          checkAuthStatus();
        }
      });
      
      // Also listen for sessionStorage changes (for permissions)
      const originalSetItem = sessionStorage.setItem;
      sessionStorage.setItem = function(key, value) {
        originalSetItem.apply(this, arguments);
        if (key === 'user_permissions') {
          checkAuthStatus();
        }
      };
    });
    
    // Define custom themes with proper block and category styles
    const customThemes = {
      'dark': Blockly.Theme.defineTheme('dark', {
        'base': Blockly.Themes.Dark,
        'blockStyles': {
          'start_blocks': {
            'colourPrimary': '#4a148c',
            'colourSecondary': '#AD7BE9',
            'colourTertiary': '#CDB6E9'
          },
          'primitive_blocks': {
            'colourPrimary': '#01579b',
            'colourSecondary': '#64C7FF',
            'colourTertiary': '#C5EAFF'
          },
          'dynamic_blocks': {
            'colourPrimary': '#4a148c',
            'colourSecondary': '#AD7BE9',
            'colourTertiary': '#CDB6E9'
          },
          'custom_blocks': {
            'colourPrimary': '#2e7d32',
            'colourSecondary': '#81c784',
            'colourTertiary': '#c8e6c9'
          }
        },
        'categoryStyles': {
          'start_category': {
            'colour': '#4a148c'
          },
          'primitive_category': {
            'colour': '#01579b'
          },
          'dynamic_category': {
            'colour': '#4a148c'
          },
          'custom_category': {
            'colour': '#2e7d32'
          }
        }
      }),
      'classic': Blockly.Theme.defineTheme('classic', {
        'base': Blockly.Themes.Classic,
        'componentStyles': {
          'workspaceBackgroundColour': '#ffffff'
        }
      }),
      'modern': Blockly.Theme.defineTheme('modern', {
        'base': Blockly.Themes.Modern,
        'blockStyles': {
          'start_blocks': {
            'colourPrimary': '#4a148c',
            'colourSecondary': '#AD7BE9',
            'colourTertiary': '#CDB6E9'
          },
          'primitive_blocks': {
            'colourPrimary': '#01579b',
            'colourSecondary': '#64C7FF',
            'colourTertiary': '#C5EAFF'
          },
          'dynamic_blocks': {
            'colourPrimary': '#4a148c',
            'colourSecondary': '#AD7BE9',
            'colourTertiary': '#CDB6E9'
          },
          'custom_blocks': {
            'colourPrimary': '#2e7d32',
            'colourSecondary': '#81c784',
            'colourTertiary': '#c8e6c9'
          }
        },
        'categoryStyles': {
          'start_category': {
            'colour': '#4a148c'
          },
          'primitive_category': {
            'colour': '#01579b'
          },
          'dynamic_category': {
            'colour': '#4a148c'
          },
          'custom_category': {
            'colour': '#2e7d32'
          }
        }
      }),
      'colorblind-wong': Blockly.Theme.defineTheme('colorblind-wong', {
        'base': Blockly.Themes.Classic
      }),
      'colorblind-tol': Blockly.Theme.defineTheme('colorblind-tol', {
        'base': Blockly.Themes.Classic
      })
    };
    
    // Available themes
    const themes = customThemes;
    
    // Make themes available globally for schema-loader.js
    window.themes = themes;
    
    // Function to restore original block colors from schemas
    function restoreOriginalColors(workspace) {
      if (!workspace) return;
      
      
      // Get the FULL schema library with colors from S3BlockLoader
      let schemaLibrary = {};
      if (window.currentS3BlockLoader && window.currentS3BlockLoader.schemaLibrary) {
        schemaLibrary = window.currentS3BlockLoader.schemaLibrary;
      } else {
        console.error('S3BlockLoader schemaLibrary not available!');
        return;
      }
      
      // Apply to workspace blocks
      const allBlocks = workspace.getAllBlocks();
      allBlocks.forEach(block => {
        try {
          // Determine the base block name (remove _array, _dict suffixes)
          let baseBlockName = block.type;
          if (baseBlockName.endsWith('_array') || baseBlockName.endsWith('_dict')) {
            baseBlockName = baseBlockName.replace(/_array$|_dict$/, '');
          }
          
          // Look up the original color from the schema
          if (schemaLibrary[baseBlockName] && schemaLibrary[baseBlockName].color !== undefined) {
            const originalColor = schemaLibrary[baseBlockName].color;
            block.setColour(originalColor);
          } else {
            // Fallback to default colors for primitive blocks
            const defaultColors = {
              'start': 250,
              'dictionary': 120,
              'dynarray': 120,
              'boolean': 155,
              'boolean_array': 155,
              'string': 190,
              'string_password': 190,
              'string_email': 190,
              'string_enum': 190,
              'string_array': 190,
              'number': 210,
              'number_array': 210
            };
            
            if (defaultColors[block.type]) {
              block.setColour(defaultColors[block.type]);
            }
          }
        } catch (e) {
          console.warn(`Failed to restore color for workspace block ${block.type}:`, e);
        }
      });
      
      // Force override toolbox blocks
      forceToolboxUpdate(workspace, 'schema');
    }
    
    // Function to apply accessibility theme colors using research-backed palettes
    function applyAccessibilityThemeColors(workspace) {
      if (!workspace) return;
      
      const savedTheme = localStorage.getItem('blockly-theme') || 'dark';
      
      // Apply to workspace blocks
      const allBlocks = workspace.getAllBlocks();
      allBlocks.forEach(block => {
        try {
          // Map block types to the 8 accessibility categories with EXACT hex colors
          let blockColor = '#888888'; // default gray
          
          if (savedTheme === 'colorblind-wong') {
            // Wong palette
            if (block.type === 'start') {
              blockColor = '#000000'; // Black
            } else if (['string', 'string_password', 'string_email', 'string_enum', 'string_array'].includes(block.type)) {
              blockColor = '#e69f00'; // Orange
            } else if (['number', 'number_array'].includes(block.type)) {
              blockColor = '#56b4e9'; // Sky blue
            } else if (['boolean', 'boolean_array'].includes(block.type)) {
              blockColor = '#009e73'; // Blue green
            } else if (!block.type.endsWith('_array') && !block.type.endsWith('_dict') && 
                     !['start', 'dictionary', 'dynarray', 'boolean', 'boolean_array', 'string', 'string_password', 'string_email', 'string_enum', 'string_array', 'number', 'number_array'].includes(block.type)) {
              blockColor = '#f0e442'; // Yellow
            } else if (block.type.endsWith('_array')) {
              blockColor = '#0072b2'; // Blue
            } else if (block.type.endsWith('_dict')) {
              blockColor = '#d55e00'; // Vermillion
            } else if (['dictionary', 'dynarray'].includes(block.type)) {
              blockColor = '#cc79a7'; // Pale violet
            }
          } else if (savedTheme === 'colorblind-tol') {
            // Tol palette
            if (block.type === 'start') {
              blockColor = '#CC6677'; // Red
            } else if (['string', 'string_password', 'string_email', 'string_enum', 'string_array'].includes(block.type)) {
              blockColor = '#332288'; // Purple
            } else if (['number', 'number_array'].includes(block.type)) {
              blockColor = '#DDCC77'; // Yellow
            } else if (['boolean', 'boolean_array'].includes(block.type)) {
              blockColor = '#117733'; // Green
            } else if (!block.type.endsWith('_array') && !block.type.endsWith('_dict') && 
                     !['start', 'dictionary', 'dynarray', 'boolean', 'boolean_array', 'string', 'string_password', 'string_email', 'string_enum', 'string_array', 'number', 'number_array'].includes(block.type)) {
              blockColor = '#88CCEE'; // Light blue
            } else if (block.type.endsWith('_array')) {
              blockColor = '#882255'; // Magenta
            } else if (block.type.endsWith('_dict')) {
              blockColor = '#44AA99'; // Teal
            } else if (['dictionary', 'dynarray'].includes(block.type)) {
              blockColor = '#AA4499'; // Pink
            }
          }
          
          // Apply the color directly
          block.setColour(blockColor);
        } catch (e) {
          console.warn(`Failed to apply accessibility theme colors to block ${block.type}:`, e);
        }
      });
      
      // Force override toolbox blocks too
      forceToolboxUpdate(workspace, 'accessibility');
    }
    
    // Function to force toolbox update with correct colors
    function forceToolboxUpdate(workspace, mode) {
      if (!workspace || !workspace.getToolbox()) return;
      
      
      try {
        // Force toolbox to re-render by closing and reopening
        const toolbox = workspace.getToolbox();
        const flyout = toolbox.getFlyout();
        
        if (flyout) {
          // Close the flyout
          flyout.hide();
          
          // Wait a moment then reopen to force re-render
          setTimeout(() => {
            // Reopen the flyout to force re-render with new colors
            const selectedCategory = toolbox.getSelectedItem();
            if (selectedCategory) {
              selectedCategory.showFlyout_();
            }
            
            // Wait for flyout to render, then update colors
            setTimeout(() => {
              if (flyout.getWorkspace()) {
                const flyoutBlocks = flyout.getWorkspace().getAllBlocks();
                
                flyoutBlocks.forEach(block => {
                  try {
                    let blockColor = 120; // default
                    
                    if (mode === 'accessibility') {
                      // Use research-backed accessibility colors with EXACT hex values
                      const savedTheme = localStorage.getItem('blockly-theme') || 'dark';
                      
                      if (savedTheme === 'colorblind-wong') {
                        // Wong palette
                        if (block.type === 'start') {
                          blockColor = '#000000'; // Black
                        } else if (['string', 'string_password', 'string_email', 'string_enum', 'string_array'].includes(block.type)) {
                          blockColor = '#e69f00'; // Orange
                        } else if (['number', 'number_array'].includes(block.type)) {
                          blockColor = '#56b4e9'; // Sky blue
                        } else if (['boolean', 'boolean_array'].includes(block.type)) {
                          blockColor = '#009e73'; // Blue green
                        } else if (!block.type.endsWith('_array') && !block.type.endsWith('_dict') && 
                                 !['start', 'dictionary', 'dynarray', 'boolean', 'boolean_array', 'string', 'string_password', 'string_email', 'string_enum', 'string_array', 'number', 'number_array'].includes(block.type)) {
                          blockColor = '#f0e442'; // Yellow
                        } else if (block.type.endsWith('_array')) {
                          blockColor = '#0072b2'; // Blue
                        } else if (block.type.endsWith('_dict')) {
                          blockColor = '#d55e00'; // Vermillion
                        } else if (['dictionary', 'dynarray'].includes(block.type)) {
                          blockColor = '#cc79a7'; // Pale violet
                        }
                      } else if (savedTheme === 'colorblind-tol') {
                        // Tol palette
                        if (block.type === 'start') {
                          blockColor = '#CC6677'; // Red
                        } else if (['string', 'string_password', 'string_email', 'string_enum', 'string_array'].includes(block.type)) {
                          blockColor = '#332288'; // Purple
                        } else if (['number', 'number_array'].includes(block.type)) {
                          blockColor = '#DDCC77'; // Yellow
                        } else if (['boolean', 'boolean_array'].includes(block.type)) {
                          blockColor = '#117733'; // Green
                        } else if (!block.type.endsWith('_array') && !block.type.endsWith('_dict') && 
                                 !['start', 'dictionary', 'dynarray', 'boolean', 'boolean_array', 'string', 'string_password', 'string_email', 'string_enum', 'string_array', 'number', 'number_array'].includes(block.type)) {
                          blockColor = '#88CCEE'; // Light blue
                        } else if (block.type.endsWith('_array')) {
                          blockColor = '#882255'; // Magenta
                        } else if (block.type.endsWith('_dict')) {
                          blockColor = '#44AA99'; // Teal
                        } else if (['dictionary', 'dynarray'].includes(block.type)) {
                          blockColor = '#AA4499'; // Pink
                        }
                      }
                    } else {
                      // Use schema colors from S3BlockLoader
                      let schemaLibrary = {};
                      if (window.currentS3BlockLoader && window.currentS3BlockLoader.schemaLibrary) {
                        schemaLibrary = window.currentS3BlockLoader.schemaLibrary;
                      }
                      
                      let baseBlockName = block.type;
                      if (baseBlockName.endsWith('_array') || baseBlockName.endsWith('_dict')) {
                        baseBlockName = baseBlockName.replace(/_array$|_dict$/, '');
                      }
                      
                      if (schemaLibrary[baseBlockName] && schemaLibrary[baseBlockName].color !== undefined) {
                        blockColor = schemaLibrary[baseBlockName].color;
                      } else {
                        const defaultColors = {
                          'start': 250,
                          'dictionary': 120,
                          'dynarray': 120,
                          'boolean': 155,
                          'boolean_array': 155,
                          'string': 190,
                          'string_password': 190,
                          'string_email': 190,
                          'string_enum': 190,
                          'string_array': 190,
                          'number': 210,
                          'number_array': 210
                        };
                        blockColor = defaultColors[block.type] || 120;
                      }
                    }
                    
                    block.setColour(blockColor);
                  } catch (e) {
                    console.warn(`Failed to apply color to toolbox block ${block.type}:`, e);
                  }
                });
              }
            }, 200); // Wait longer for flyout to fully render
          }, 100);
        }
      } catch (e) {
        console.warn('Failed to force toolbox update:', e);
      }
    }
    
    
    // Function to apply accessibility theme colors
    function applyAccessibilityColors(workspace, theme) {
      if (!workspace) return;
      
      const allBlocks = workspace.getAllBlocks();
      allBlocks.forEach(block => {
        // Store original color if not already stored
        if (block._originalColor === undefined) {
          try {
            // Get current color before applying theme
            const currentColor = block.getColour();
            if (currentColor !== undefined) {
              block._originalColor = currentColor;
            }
          } catch (e) {
            console.warn(`Failed to store original color for block ${block.type}:`, e);
          }
        }
      });
    }
    
    function changeTheme() {
      const themeSelect = document.getElementById('themeSelect');
      const selectedTheme = themeSelect.value;
      
      console.log('Selected theme:', selectedTheme);
      
      if (currentWorkspace && themes[selectedTheme]) {
        // Check if this is an accessibility theme
        const isAccessibilityTheme = ['colorblind-wong', 'colorblind-tol'].includes(selectedTheme);
        
        console.log('Is accessibility theme:', isAccessibilityTheme);
        
        // Save theme to localStorage FIRST
        localStorage.setItem('blockly-theme', selectedTheme);
        
        // Apply Blockly theme first
        currentWorkspace.setTheme(themes[selectedTheme]);
        
        // Then override ALL block colors directly
        if (isAccessibilityTheme) {
          // For accessibility themes, apply 8-color palette
          applyAccessibilityThemeColors(currentWorkspace);
        } else {
          // For normal themes, restore original schema colors
          restoreOriginalColors(currentWorkspace);
        }
        
        // Change UI background based on theme
        const root = document.documentElement;
        const body = document.body;
        
        // Remove all theme classes first
        body.classList.remove('classic-theme', 'modern-theme', 'dark-theme');
        
        if (selectedTheme === 'classic') {
          // Classic theme: white background
          root.style.setProperty('--bg-color', '#ffffff');
          root.style.setProperty('--text-color', '#000000');
          root.style.setProperty('--blockly-bg', '#fafafa');
          root.style.setProperty('--controls-bg', '#ffffff');
          root.style.setProperty('--border-color', '#e0e0e0');
          body.classList.add('classic-theme');
        } else if (selectedTheme === 'modern') {
          // Modern theme: light background
          root.style.setProperty('--bg-color', '#ffffff');
          root.style.setProperty('--text-color', '#000000');
          root.style.setProperty('--blockly-bg', '#fafafa');
          root.style.setProperty('--controls-bg', '#ffffff');
          root.style.setProperty('--border-color', '#e0e0e0');
          body.classList.add('modern-theme');
        } else {
          // Dark themes: keep dark UI background
          root.style.setProperty('--bg-color', '#1e1e1e');
          root.style.setProperty('--text-color', '#ffffff');
          root.style.setProperty('--blockly-bg', '#1e1e1e');
          root.style.setProperty('--controls-bg', '#2d2d30');
          root.style.setProperty('--border-color', '#444');
          body.classList.add('dark-theme');
        }
        
        // Theme preference already saved above
      }
    }
    
    // Load saved theme preference
    function loadThemePreference() {
      const savedTheme = localStorage.getItem('blockly-theme') || 'dark';
      const themeSelect = document.getElementById('themeSelect');
      themeSelect.value = savedTheme;
      
      // Apply UI background changes immediately
      const root = document.documentElement;
      const body = document.body;
      
      // Remove all theme classes first
      body.classList.remove('classic-theme', 'modern-theme', 'dark-theme');
      
      if (savedTheme === 'classic') {
        // Classic theme: white background
        root.style.setProperty('--bg-color', '#ffffff');
        root.style.setProperty('--text-color', '#000000');
        root.style.setProperty('--blockly-bg', '#fafafa');
        root.style.setProperty('--controls-bg', '#ffffff');
        root.style.setProperty('--border-color', '#e0e0e0');
        body.classList.add('classic-theme');
      } else if (savedTheme === 'modern') {
        // Modern theme: light background
        root.style.setProperty('--bg-color', '#ffffff');
        root.style.setProperty('--text-color', '#000000');
        root.style.setProperty('--blockly-bg', '#fafafa');
        root.style.setProperty('--controls-bg', '#ffffff');
        root.style.setProperty('--border-color', '#e0e0e0');
        body.classList.add('modern-theme');
      } else {
        // Dark themes: keep dark UI background
        root.style.setProperty('--bg-color', '#1e1e1e');
        root.style.setProperty('--text-color', '#ffffff');
        root.style.setProperty('--blockly-bg', '#1e1e1e');
        root.style.setProperty('--controls-bg', '#2d2d30');
        root.style.setProperty('--border-color', '#444');
        body.classList.add('dark-theme');
      }
      
      // Apply theme to workspace if available
      if (currentWorkspace && themes[savedTheme]) {
        // Check if this is an accessibility theme
        const isAccessibilityTheme = ['colorblind-wong', 'colorblind-tol'].includes(savedTheme);
        
        // Apply Blockly theme first
        currentWorkspace.setTheme(themes[savedTheme]);
        
        // Then override ALL block colors directly
        if (isAccessibilityTheme) {
          // For accessibility themes, apply 8-color palette
          applyAccessibilityThemeColors(currentWorkspace);
        } else {
          // For normal themes, restore original schema colors
          restoreOriginalColors(currentWorkspace);
        }
      }
    }
    
    // Function to get workspace reference and apply theme
    function applyThemeToWorkspace() {
      if (typeof Blockly !== 'undefined' && Blockly.getMainWorkspace) {
        currentWorkspace = Blockly.getMainWorkspace();
        
        // Check if workspace is actually available
        if (!currentWorkspace) {
          setTimeout(applyThemeToWorkspace, 100);
          return;
        }
        
        window.currentWorkspace = currentWorkspace;
        
        // Apply saved theme
        loadThemePreference();
        
        // Add change listener to apply theme to new blocks
        currentWorkspace.addChangeListener((event) => {
          if (event.type === Blockly.Events.BLOCK_CREATE || event.type === Blockly.Events.BLOCK_CHANGE) {
            // Apply current theme to new/changed blocks
            const savedTheme = localStorage.getItem('blockly-theme') || 'dark';
            const isAccessibilityTheme = ['colorblind-wong', 'colorblind-tol'].includes(savedTheme);
            
            // Apply theme colors to new blocks
            if (isAccessibilityTheme) {
              applyAccessibilityThemeColors(currentWorkspace);
            } else {
              restoreOriginalColors(currentWorkspace);
            }
          }
        });
        
        // Add variable block listener to update newly created variable blocks
        if (window.addVariableBlockListener) {
          window.addVariableBlockListener(currentWorkspace);
        }
      } else {
        // Retry after a short delay if workspace isn't ready yet
        setTimeout(applyThemeToWorkspace, 100);
      }
    }
    
    // Load theme preference immediately when page loads (after themes are defined)
    loadThemePreference();
    
    // Override the S3BlockLoader initializeBlockly method to store workspace reference
    // Wait for S3BlockLoader to be defined
    function overrideS3BlockLoaderInitializeBlockly() {
      if (typeof S3BlockLoader !== 'undefined' && S3BlockLoader.prototype.initializeBlockly) {
        const originalInitializeBlockly = S3BlockLoader.prototype.initializeBlockly;
        S3BlockLoader.prototype.initializeBlockly = function() {
          // Call the original method
          const result = originalInitializeBlockly.call(this);
          
          // Store the workspace reference
          if (typeof Blockly !== 'undefined' && Blockly.getMainWorkspace) {
            currentWorkspace = Blockly.getMainWorkspace();
            window.currentWorkspace = currentWorkspace;
            
            // Apply saved theme
            loadThemePreference();
          }
          
          return result;
        };
      } else {
        // Retry after a short delay if S3BlockLoader is not yet defined
        setTimeout(overrideS3BlockLoaderInitializeBlockly, 100);
      }
    }
    
    // Start the override process
    overrideS3BlockLoaderInitializeBlockly();
    
    // Override the workspace initialization to store reference and apply theme
    const originalInitialize = window.initialize;
    window.initialize = function() {
      if (originalInitialize) {
        originalInitialize();
      }
      
      // Apply theme after workspace is initialized
      setTimeout(applyThemeToWorkspace, 200);
    };
    
     // Function to force workspace resize
     function forceWorkspaceResize() {
         const workspace = currentWorkspace || Blockly.getMainWorkspace();
         if (workspace) {
             workspace.resize();
         }
     }
     
     // Handle window resize events to ensure workspace scales properly
     let resizeTimeout;
     window.addEventListener('resize', function() {
         // Clear existing timeout
         clearTimeout(resizeTimeout);
         
         // Debounce resize to avoid excessive calls
         resizeTimeout = setTimeout(() => {
             forceWorkspaceResize();
         }, 100);
     });
     
     // Function to toggle the controls panel
     function toggleControlsPanel() {
         const panel = document.querySelector('.controls-panel');
         const container = document.getElementById('blocklyContainer');
         const toggle = document.getElementById('panelToggle');
         const toggleText = document.getElementById('panelToggleText');
         
         if (panel && container && toggle && toggleText) {
             const isOpen = panel.classList.contains('open');
             
             if (isOpen) {
                 // Close panel
                 panel.classList.remove('open');
                 container.classList.remove('panel-open');
                 toggle.classList.remove('panel-open');
                 toggleText.textContent = '◀ API Controls';
                 
                 // Force Blockly workspace to resize after transition
                 setTimeout(() => {
                     // Dispatch a resize event to trigger the window resize handler
                     window.dispatchEvent(new Event('resize'));
                 }, 305); // Wait for CSS transition (300ms) plus small buffer
             } else {
                 // Open panel
                 panel.classList.add('open');
                 container.classList.add('panel-open');
                 toggle.classList.add('panel-open');
                 toggleText.textContent = '▶ Close';
                 
                 // Force Blockly workspace to resize after transition
                 setTimeout(() => {
                     // Dispatch a resize event to trigger the window resize handler
                     window.dispatchEvent(new Event('resize'));
                 }, 305); // Wait for CSS transition (300ms) plus small buffer
             }
         }
     }
     
     
     // Function to handle comment query parameter
     function handleCommentParameter() {
        const urlParams = new URLSearchParams(window.location.search);
        const commentParam = urlParams.get('comment');
        
        if (!commentParam) {
            return; // No comment parameter, no action needed
        }
        
        try {
            // Parse the comment parameter as JSON array
            const comments = JSON.parse(commentParam);
            
            // Validate that it's an array of strings
            if (!Array.isArray(comments) || comments.length === 0) {
                console.log('Comment parameter is not a non-empty array, ignoring');
                return;
            }
            
            // Check if all items are strings
            if (!comments.every(item => typeof item === 'string')) {
                console.log('Comment parameter contains non-string items, ignoring');
                return;
            }
            
            console.log('Creating comment blocks for:', comments);
            
            // Wait for workspace to be available
            const createCommentBlocks = () => {
                const workspace = window.currentWorkspace || Blockly.getMainWorkspace();
                if (!workspace) {
                    setTimeout(createCommentBlocks, 100);
                    return;
                }
                
                // Check if string_array block type exists
                if (!Blockly.Blocks['string_array']) {
                    console.warn('string_array block type not found, cannot create comment blocks');
                    return;
                }
                
                // Create an unattached string_array block
                const stringArrayBlock = workspace.newBlock('string_array');
                stringArrayBlock.initSvg();
                stringArrayBlock.render();
                
                // Position the comment block at the top (above the root start block)
                // The start block is positioned at (20, 20), so position comment blocks above it
                const startBlock = workspace.getTopBlocks(false).find(block => block.type === 'start');
                let yPosition = 20; // Default position if no start block found
                
                if (startBlock) {
                    // Position comment blocks above the start block
                    yPosition = 20; // Top position for comment blocks
                    
                    // Move the start block (and its descendants) down to make room for comments
                    const startBlockXY = startBlock.getRelativeToSurfaceXY();
                    const commentBlockHeight = 60; // Base height for comment block
                    const commentSpacing = 28; // Additional spacing per comment
                    const totalCommentHeight = commentBlockHeight + (comments.length * commentSpacing);
                    
                    // Move start block down by the total comment height plus 30px gap
                    startBlock.moveBy(0, totalCommentHeight + 30);
                }
                
                stringArrayBlock.moveBy(20, yPosition);
                
                // Populate the string_array block with individual string blocks for each comment
                comments.forEach((comment, index) => {
                    try {
                        // Manually create the input (following the pattern from json-workspace-converter.js)
                        // This avoids the automatic string block creation that appendElementInput() does
                        const lastIndex = stringArrayBlock.length || 0;
                        stringArrayBlock.length = lastIndex + 1;
                        
                        // Create the input manually
                        const newInput = stringArrayBlock.appendValueInput('element_' + lastIndex);
                        newInput.appendField(new Blockly.FieldTextbutton('–', function() { 
                            if (this.sourceBlock_) {
                                this.sourceBlock_.deleteElementInput(newInput);
                                if (typeof updateJSONarea === 'function') {
                                    updateJSONarea(this.sourceBlock_.workspace);
                                }
                            }
                        }));
                        
                        // Create string block directly
                        const stringBlock = stringArrayBlock.workspace.newBlock('string');
                        stringBlock.initSvg();
                        stringBlock.render();
                        
                        // Connect the string block to the input
                        newInput.connection.connect(stringBlock.outputConnection);
                        
                        // Set the string value to the comment text using setFieldValue
                        stringBlock.setFieldValue(comment, 'string_value');
                        
                    } catch (e) {
                        console.warn(`Failed to create comment block for comment ${index + 1}:`, e);
                    }
                });
                
                // Update the JSON area to reflect the new blocks
                if (typeof updateJSONarea === 'function') {
                    setTimeout(() => {
                        updateJSONarea(workspace);
                    }, 100);
                }
            };
            
            // Start creating comment blocks
            createCommentBlocks();
            
        } catch (e) {
            console.warn('Failed to parse comment parameter:', e);
        }
    }
    
     // Call handleCommentParameter after workspace initialization
     const originalInitializeForComments = window.initialize;
     window.initialize = function() {
         if (originalInitializeForComments) {
             originalInitializeForComments();
         }
         
         // Handle comment parameter after initialization
         setTimeout(handleCommentParameter, 500);
         
         // Set up zoom change listener for footer buttons
         setTimeout(() => {
             const workspace = Blockly.getMainWorkspace && Blockly.getMainWorkspace();
             if (workspace) {
                 // Listen for zoom changes
                 workspace.addChangeListener(function(event) {
                     if (event.type === Blockly.Events.UI && event.element === 'zoom') {
                         // Update all dropdown scales when zoom changes
                         if (typeof window.updateAllDropdownScales === 'function') {
                             window.updateAllDropdownScales(workspace);
                         }
                     }
                 });
                 
             }
         }, 1000);
         
    // Add keyboard shortcut for panel toggle (Escape key)
    document.addEventListener('keydown', function(event) {
        if (event.key === 'Escape') {
            toggleControlsPanel();
        }
    });

    // Function to show validation error button with formatted error message
    function showValidationError(errorMessage) {
        const errorButton = document.getElementById('validationErrorButton');
        if (errorButton) {
            // Reset any previous state first
            errorButton.style.transform = 'scale(1)';
            
            // Parse the error message to extract key information
            const lines = errorMessage.split('\n');
            let errorType = 'error';
            let errorLocation = '';
            
            // Extract error type and location from the formatted error message
            for (const line of lines) {
                if (line.startsWith('Error: ')) {
                    errorType = line.replace('Error: ', '').trim();
                } else if (line.startsWith('Location: ')) {
                    errorLocation = line.replace('Location: ', '').trim();
                }
            }
            
            // Format the button text as requested: "[Error emoji] enum: /gender"
            const buttonText = `❌ ${errorType}: ${errorLocation}`;
            errorButton.textContent = buttonText;
            errorButton.style.display = 'inline-block';
            
            // Add click handler to show full error details
            errorButton.onclick = function() {
                alert('Full validation error:\n\n' + errorMessage);
            };
        }
    }

    // Function to hide validation error button
    function hideValidationError() {
        const errorButton = document.getElementById('validationErrorButton');
        if (errorButton) {
            errorButton.style.display = 'none';
            errorButton.style.transform = 'scale(1)'; // Reset transform to prevent hover state persistence
            errorButton.textContent = '❌ Validation Error'; // Reset text to default
        }
    }

    // Make these functions globally available
    window.showValidationError = showValidationError;
    window.hideValidationError = hideValidationError;
    
    // Function to show endpoint info popup
    window.showEndpointInfo = function() {
        const endpointSelector = document.getElementById('endpoint_selector');
        const modal = document.getElementById('endpointInfoModal');
        const content = document.getElementById('endpointInfoContent');
        
        if (!endpointSelector || !modal || !content) return;
        
        const selectedEndpoint = endpointSelector.value;
        if (!selectedEndpoint) return;
        
        // Find the endpoint description
        const description = window.getEndpointDescription(selectedEndpoint);
        if (!description) {
            content.textContent = 'No information available for this endpoint.';
        } else {
            try {
                const descObj = JSON.parse(description);
                let html = '';
                
                if (descObj.summary) {
                    html += `<p><strong>Summary:</strong> ${escapeHtml(descObj.summary)}</p>`;
                }
                if (descObj.description) {
                    html += `<p><strong>Description:</strong> ${escapeHtml(descObj.description)}</p>`;
                }
                if (descObj.parameters && descObj.parameters.length > 0) {
                    html += `<p><strong>Parameters:</strong></p><ul>`;
                    descObj.parameters.forEach(param => {
                        html += `<li><code>${escapeHtml(param.name)}</code> (${escapeHtml(param.in)})${param.required ? ' <strong>*required</strong>' : ''}${param.description ? `: ${escapeHtml(param.description)}` : ''}</li>`;
                    });
                    html += `</ul>`;
                }
                if (descObj.responses && descObj.responses.length > 0) {
                    html += `<p><strong>Response Codes:</strong> ${descObj.responses.join(', ')}</p>`;
                }
                if (descObj.security && descObj.security.length > 0) {
                    html += `<p><strong>Security:</strong> ${descObj.security.join(', ')}</p>`;
                }
                
                content.innerHTML = html;
            } catch (e) {
                content.textContent = description;
            }
        }
        
        modal.classList.remove('modal-hidden');
        modal.classList.add('modal-visible');
    };
    
    // Function to close endpoint info popup
    window.closeEndpointInfo = function() {
        const modal = document.getElementById('endpointInfoModal');
        if (modal) {
            modal.classList.remove('modal-visible');
            modal.classList.add('modal-hidden');
        }
    };
    
    // Helper function to escape HTML
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Close modal when clicking outside
    document.addEventListener('click', function(event) {
        const modal = document.getElementById('endpointInfoModal');
        if (modal && event.target === modal) {
            closeEndpointInfo();
        }
        
        const aiModal = document.getElementById('aiAssistModal');
        if (aiModal && event.target === aiModal) {
            closeAIAssistPanel();
        }
    });
    
    // AI Assist Functions
    window.openAIAssistPanel = function() {
        const modal = document.getElementById('aiAssistModal');
        if (modal) {
            modal.classList.remove('modal-hidden');
            modal.classList.add('modal-visible');
            
            // Clear previous content
            document.getElementById('aiAssistInstructions').value = '';
            document.getElementById('aiAssistResponse').style.display = 'none';
            document.getElementById('aiAssistLoading').style.display = 'none';
        }
    };
    
    window.closeAIAssistPanel = function() {
        const modal = document.getElementById('aiAssistModal');
        if (modal) {
            modal.classList.remove('modal-visible');
            modal.classList.add('modal-hidden');
        }
    };
    
    window.submitAIAssistRequest = async function() {
        const instructions = document.getElementById('aiAssistInstructions').value.trim();
        if (!instructions) {
            alert('Please enter transformation instructions');
            return;
        }
        
        // Show loading state
        document.getElementById('aiAssistLoading').style.display = 'block';
        document.getElementById('aiAssistResponse').style.display = 'none';
        document.getElementById('aiAssistSubmit').disabled = true;
        
        try {
            // Get current schema
            const rootSchemaType = document.getElementById('root_schema_type').value.trim();
            const schemaText = rootSchemaType ? `The schema is: ${rootSchemaType}` : 'No specific schema type is set';
            
            // Get current validation issues
            const responseArea = document.getElementById('response_area');
            const validationIssues = responseArea ? responseArea.value : 'No validation issues found';
            
            // Get current JSON
            const jsonArea = document.getElementById('json_area');
            const currentJson = jsonArea ? jsonArea.value : '{}';
            
            // Build the prompt - incorporate existing JSON as starting point
            const prompt = `Transform the current json to fit the schema and following the user's direction. ${schemaText}. The custom instructions are: ${instructions}. Current validation issues are: ${validationIssues}. The current object is: ${currentJson}`;
            
            // Get tenant from URL or localStorage
            const urlParams = new URLSearchParams(window.location.search);
            let tenant = urlParams.get('tenant');
            if (!tenant) {
                tenant = localStorage.getItem('last_tenant') || 'meta';
            }
            
            // Make API request using the llm-preload endpoint (designed for custom instructions)
            const response = await fetch(window.API_CONFIG.LLM_PRELOAD_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    type: 'llm-preload',
                    body: {
                        extension: tenant,
                        prompt: prompt
                    }
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (response.ok) {
                // Parse the nested body field
                const responseBody = JSON.parse(data.body);
                const jsonObject = responseBody.json_object;
                let rootSchema = responseBody.root_schema;
                
                // Remove .json extension if present and lowercase
                if (rootSchema && rootSchema.endsWith('.json')) {
                    rootSchema = rootSchema.replace('.json', '');
                }
                if (rootSchema) {
                    rootSchema = rootSchema.toLowerCase();
                }
                
                console.log('AI Assist - Extracted jsonObject:', jsonObject);
                console.log('AI Assist - Extracted rootSchema:', rootSchema);
                
                // URL encode the JSON object
                const encodedJson = encodeURIComponent(JSON.stringify(jsonObject));
                
                // Build the redirect URL
                const redirectUrl = `/?tenant=${encodeURIComponent(tenant)}&initial=${encodedJson}&rootSchema=${encodeURIComponent(rootSchema)}`;
                
                console.log('AI Assist - Redirect URL:', redirectUrl);
                
                // Show success message and redirect
                document.getElementById('aiAssistResponseContent').innerHTML = `
                    <h4 style="color: #4CAF50; margin-top: 0;">✅ Success!</h4>
                    <p><strong>Detected Schema:</strong> ${rootSchema}</p>
                    <p><strong>Transformed Object:</strong></p>
                    <pre style="background: #1e1e1e; padding: 10px; border-radius: 3px; overflow-x: auto; color: #fff; font-size: 12px;">${JSON.stringify(jsonObject, null, 2)}</pre>
                    <p>Auto-redirecting in <span id="aiCountdown">3</span> seconds...</p>
                `;
                document.getElementById('aiAssistResponse').style.display = 'block';
                
                // Countdown timer
                let countdown = 3;
                const countdownElement = document.getElementById('aiCountdown');
                const countdownInterval = setInterval(() => {
                    countdown--;
                    if (countdownElement) {
                        countdownElement.textContent = countdown;
                    }
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        window.location.href = redirectUrl;
                    }
                }, 1000);
                
            } else {
                // Error
                const errorMessage = data.error || data.message || 'Unknown error occurred';
                document.getElementById('aiAssistResponseContent').innerHTML = `
                    <h4 style="color: #ff6b6b; margin-top: 0;">❌ Error</h4>
                    <p><strong>${errorMessage}</strong></p>
                    ${data.errors ? `<p>Details: ${data.errors.join(', ')}</p>` : ''}
                `;
                document.getElementById('aiAssistResponse').style.display = 'block';
            }
            
        } catch (error) {
            console.error('AI Assist request failed:', error);
            document.getElementById('aiAssistResponseContent').innerHTML = `
                <h4 style="color: #ff6b6b; margin-top: 0;">❌ Error</h4>
                <p><strong>${error.message}</strong></p>
            `;
            document.getElementById('aiAssistResponse').style.display = 'block';
        } finally {
            // Hide loading state
            document.getElementById('aiAssistLoading').style.display = 'none';
            document.getElementById('aiAssistSubmit').disabled = false;
        }
    };
    
    
     };
    
    // Blockly initialization is now handled by dynamic-blocks.js
    // This ensures blocks are loaded based on tenant schemas before initialization

    function handleAuthError(response) {
        if (response.status === 500) {
            response.json().then(data => {
                if (data.error === 'Authentication service error' && data.message === 'Unable to verify authentication') {
                    const loginButton = document.getElementById('loginButton');
                    if (loginButton) {
                        loginButton.style.display = 'flex';
                    }
                }
            }).catch(error => console.error('Failed to parse JSON response:', error));
        }
    }

    // Example usage in a fetch call
    fetch('SOME_URL').then(response => {
        if (!response.ok) {
            handleAuthError(response);
        }
        // ... existing code ...
    }).catch(error => {
        console.error('Fetch error:', error);
        handleAuthError({ status: 500, json: () => Promise.resolve({ error: 'Authentication service error', message: 'Unable to verify authentication' }) });
    });
  </script>
</body>
</html>

